name: Docker PostGIS CI

# this is the x86_64/amd64 build generated via github actions

on:
  push:
  pull_request:
  schedule:
    - cron: '15 5 * * 1'

defaults:
  run:
    shell: bash

jobs:
  make-docker-images:
    strategy:
      matrix:
        include:
#
# They are created using the ./apply-ci.sh script based on the version.json file,
#
# These "--skip--" images serve as inputs for the "*-bundle" images,
#       hence they must be generated within the bundle JOB.
#
#matrix-include-start
           - { version: "15-3.4", variant: "alpine3.18", postgres: "15", postgis: "3.4", arch: "amd64", tags: "15-3.4-alpine3.18 15-3.4.0-alpine3.18 15-3.4-alpine alpine", readme_group: "alpine3.18" }
           - { version: "15-3.4", variant: "bookworm", postgres: "15", postgis: "3.4", arch: "amd64 arm64", tags: "15-3.4-bookworm 15-3.4.0-bookworm 15-3.4 latest", readme_group: "bookworm" }
           - { version: "15-3.4", variant: "bullseye", postgres: "15", postgis: "3.4", arch: "amd64", tags: "15-3.4-bullseye 15-3.4.0-bullseye", readme_group: "bullseye" }
#matrix-include-end

    name: "${{ matrix.version }}-${{ matrix.variant }} docker image"
    runs-on: ubuntu-22.04
    continue-on-error: ${{ matrix.postgis == 'master' }}

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Load Environment Variables from the .env file
      run: |
        set -a
        source .env
        set +a
        echo " "
        if [ -z "$REGISTRY" ] || [ -z "$REPO_NAME" ] || [ -z "$IMAGE_NAME" ]; then
          echo "Error: REGISTRY,REPO_NAME and IMAGE_NAME must be set" >&2
          exit 1
        else
          echo " ----  .env file loaded ----"
          echo " - REGISTRY: $REGISTRY"
          echo " - REPO_NAME: $REPO_NAME"
          echo " - IMAGE_NAME: $IMAGE_NAME"
        fi

    - name: "make test-${{ matrix.version }}-${{ matrix.variant }} tags ${{ matrix.tags }}"
      run: make test-${{ matrix.version }}-${{ matrix.variant }}

    - name: Login to dockerhub
      uses: docker/login-action@v2
      if: ${{  (github.ref == 'refs/heads/master') && (github.event_name != 'pull_request')  }}
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}

    - name: Push docker image to dockerhub
      if: ${{  (github.ref == 'refs/heads/master') && (github.event_name != 'pull_request')  }}
      env:
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_ACCESS_TOKEN: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}
      run: make push-${{ matrix.version }}-${{ matrix.variant }}

